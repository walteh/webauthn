{
    Name: "deployment-pipeline",
    SchemaVersion: "1.0",
    Triggers: [{ Type: "PUSH", Branches: ["revamp", "main"] }],
    Actions:
        {
            Build:
                {
                    Actions:
                        {
                            Package:
                                {
                                    Identifier: "aws/build@v1",
                                    Inputs: { Sources: ["WorkflowSource"] },
                                    Outputs:
                                        {
                                            AutoDiscoverReports:
                                                {
                                                    Enabled: true,
                                                    ReportNamePrefix: "build",
                                                    SuccessCriteria:
                                                        { PassRate: 100 },
                                                },
                                            Artifacts:
                                                [
                                                    {
                                                        Name: "package",
                                                        Files: ["./bin/out"],
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            Steps:
                                                [
                                                    {
                                                        Run: "cd /root/.goenv/plugins/go-build/../.. && git pull && cd - && goenv install 1.21.5 && goenv global 1.21.5",
                                                    },
                                                    {
                                                        Run: "npm install -g @go-task/cli",
                                                    },
                                                    { Run: "task test-ci" },
                                                    {
                                                        Run: "go build -o ./bin/out ./cmd",
                                                    },
                                                ],
                                        },
                                    Compute:
                                        { Type: EC2, Fleet: Linux.Arm64.Large },
                                },
                            Synth:
                                {
                                    Identifier: "aws/build@v1",
                                    Inputs: { Sources: ["WorkflowSource"] },
                                    Outputs:
                                        {
                                            AutoDiscoverReports:
                                                {
                                                    Enabled: true,
                                                    ReportNamePrefix: "synth",
                                                    IncludePaths:
                                                        ["test-reports/*"],
                                                    SuccessCriteria:
                                                        { PassRate: 100 },
                                                },
                                            Artifacts:
                                                [
                                                    {
                                                        Name: "synth",
                                                        Files:
                                                            [
                                                                "cdk.out/**/*",
                                                                "cdk.json",
                                                            ],
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            Steps:
                                                [
                                                    {
                                                        Run: "cd /root/.goenv/plugins/go-build/../.. && git pull && cd - && goenv install 1.21.5 && goenv global 1.21.5",
                                                    },
                                                    {
                                                        Run: "npm install -g @go-task/cli",
                                                    },
                                                    { Run: "task test-cdk-ci" },
                                                    { Run: "task cdk-synth" },
                                                    {
                                                        Run: "mv infrastructure/cdk.out .",
                                                    },
                                                    {
                                                        Run: "mv infrastructure/cdk.json .",
                                                    },
                                                ],
                                        },
                                    Compute:
                                        { Type: EC2, Fleet: Linux.Arm64.Large },
                                },
                        },
                },
            Beta:
                {
                    Actions:
                        {
                            Deploy:
                                {
                                    Identifier: "aws/cdk-deploy@v1",
                                    DependsOn: ["Build"],
                                    Inputs: { Sources: ["WorkflowSource"] },
                                    Environment:
                                        {
                                            Name: "beta",
                                            Connections:
                                                [
                                                    {
                                                        Name: "main",
                                                        Role: "CodeCatalystWorkflowDevelopmentRole-nugg.xyz",
                                                    },
                                                ],
                                        },
                                    Configuration: {
                                            StackName: "sample-cdk-pipeline",
                                            Region: "us-east-1",
                                            Context: '{"deploymentConfigurationName":"CodeDeployDefault.ECSCanary10Percent5Minutes"}',
                                            CdkRootPath: infrastructure,
                                            # CfnOutputVariables: '["endpointUrl"]',,
                                        },
                                },
                            Test:
                                {
                                    Identifier: "aws/managed-test@v1",
                                    Inputs:
                                        {
                                            Artifacts: ["synth"],
                                            Variables:
                                                [
                                                    {
                                                        Name: "endpointUrl",
                                                        Value: "${Deploy.endpointUrl}",
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            Steps:
                                                [
                                                    {
                                                        Run: "mvn --batch-mode --no-transfer-progress soapui:test -Dsoapui.endpoint=${endpointUrl}",
                                                    },
                                                    {
                                                        Run: "mvn --batch-mode --no-transfer-progress compile jmeter:jmeter jmeter:results -Djmeter.endpoint=${endpointUrl} -Djmeter.threads=300 -Djmeter.duration=300 -Djmeter.throughput=6000",
                                                    },
                                                ],
                                        },
                                    Outputs:
                                        {
                                            AutoDiscoverReports:
                                                {
                                                    Enabled: true,
                                                    IncludePaths:
                                                        [
                                                            "target/soapui-reports/*",
                                                        ],
                                                    ReportNamePrefix: "Beta",
                                                    SuccessCriteria:
                                                        { PassRate: 100 },
                                                },
                                        },
                                },
                        },
                    DependsOn: ["Build"],
                },
            Gamma-us-west-2:
                {
                    Actions:
                        {
                            Deploy:
                                {
                                    Identifier: "aws/cdk-deploy@v1",
                                    DependsOn: ["Beta"],
                                    Inputs: { Artifacts: ["synth"] },
                                    Environment:
                                        {
                                            Name: "Gamma",
                                            Connections:
                                                [
                                                    {
                                                        Name: "gamma",
                                                        Role: "codecatalyst",
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            StackName: "fruit-api",
                                            Region: "us-west-2",
                                            Context: '{"deploymentConfigurationName":"CodeDeployDefault.ECSCanary10Percent5Minutes"}',
                                            CfnOutputVariables: '["endpointUrl"]',
                                        },
                                },
                            Test:
                                {
                                    Identifier: "aws/managed-test@v1",
                                    Inputs:
                                        {
                                            Artifacts: ["synth"],
                                            Variables:
                                                [
                                                    {
                                                        Name: "endpointUrl",
                                                        Value: "${Deploy.endpointUrl}",
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            Steps:
                                                [
                                                    {
                                                        Run: "mvn --batch-mode --no-transfer-progress soapui:test -Dsoapui.endpoint=${endpointUrl}",
                                                    },
                                                    {
                                                        Run: "mvn --batch-mode --no-transfer-progress compile jmeter:jmeter jmeter:results -Djmeter.endpoint=${endpointUrl} -Djmeter.threads=300 -Djmeter.duration=300 -Djmeter.throughput=6000",
                                                    },
                                                ],
                                        },
                                    Outputs:
                                        {
                                            AutoDiscoverReports:
                                                {
                                                    Enabled: true,
                                                    IncludePaths:
                                                        [
                                                            "target/soapui-reports/*",
                                                        ],
                                                    ReportNamePrefix: "Gamma-us-west-2",
                                                    SuccessCriteria:
                                                        { PassRate: 100 },
                                                },
                                        },
                                },
                        },
                    DependsOn: ["Beta"],
                },
            Gamma-us-east-1:
                {
                    Actions:
                        {
                            Deploy:
                                {
                                    Identifier: "aws/cdk-deploy@v1",
                                    DependsOn: ["Beta"],
                                    Inputs: { Artifacts: ["synth"] },
                                    Environment:
                                        {
                                            Name: "Gamma",
                                            Connections:
                                                [
                                                    {
                                                        Name: "gamma",
                                                        Role: "codecatalyst",
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            StackName: "fruit-api",
                                            Region: "us-east-1",
                                            Context: '{"deploymentConfigurationName":"CodeDeployDefault.ECSCanary10Percent5Minutes"}',
                                            CfnOutputVariables: '["endpointUrl"]',
                                        },
                                },
                            Test:
                                {
                                    Identifier: "aws/managed-test@v1",
                                    Inputs:
                                        {
                                            Artifacts: ["synth"],
                                            Variables:
                                                [
                                                    {
                                                        Name: "endpointUrl",
                                                        Value: "${Deploy.endpointUrl}",
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            Steps:
                                                [
                                                    {
                                                        Run: "mvn --batch-mode --no-transfer-progress soapui:test -Dsoapui.endpoint=${endpointUrl}",
                                                    },
                                                    {
                                                        Run: "mvn --batch-mode --no-transfer-progress compile jmeter:jmeter jmeter:results -Djmeter.endpoint=${endpointUrl} -Djmeter.threads=300 -Djmeter.duration=300 -Djmeter.throughput=6000",
                                                    },
                                                ],
                                        },
                                    Outputs:
                                        {
                                            AutoDiscoverReports:
                                                {
                                                    Enabled: true,
                                                    IncludePaths:
                                                        [
                                                            "target/soapui-reports/*",
                                                        ],
                                                    ReportNamePrefix: "Gamma-us-east-1",
                                                    SuccessCriteria:
                                                        { PassRate: 100 },
                                                },
                                        },
                                },
                        },
                    DependsOn: ["Beta"],
                },
            Prod-us-west-2:
                {
                    Actions:
                        {
                            Deploy:
                                {
                                    Identifier: "aws/cdk-deploy@v1",
                                    DependsOn:
                                        ["Gamma-us-west-2", "Gamma-us-east-1"],
                                    Inputs: { Artifacts: ["synth"] },
                                    Environment:
                                        {
                                            Name: "Production",
                                            Connections:
                                                [
                                                    {
                                                        Name: "prod",
                                                        Role: "codecatalyst",
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            StackName: "fruit-api",
                                            Region: "us-west-2",
                                            Context: '{"deploymentConfigurationName":"CodeDeployDefault.ECSCanary10Percent5Minutes"}',
                                            CfnOutputVariables: '["endpointUrl"]',
                                        },
                                },
                        },
                    DependsOn: ["Gamma-us-west-2", "Gamma-us-east-1"],
                },
            Prod-us-east-1:
                {
                    Actions:
                        {
                            Deploy:
                                {
                                    Identifier: "aws/cdk-deploy@v1",
                                    DependsOn:
                                        ["Gamma-us-west-2", "Gamma-us-east-1"],
                                    Inputs: { Artifacts: ["synth"] },
                                    Environment:
                                        {
                                            Name: "Production",
                                            Connections:
                                                [
                                                    {
                                                        Name: "prod",
                                                        Role: "codecatalyst",
                                                    },
                                                ],
                                        },
                                    Configuration:
                                        {
                                            StackName: "fruit-api",
                                            Region: "us-east-1",
                                            Context: '{"deploymentConfigurationName":"CodeDeployDefault.ECSCanary10Percent5Minutes"}',
                                            CfnOutputVariables: '["endpointUrl"]',
                                        },
                                },
                        },
                    DependsOn: ["Gamma-us-west-2", "Gamma-us-east-1"],
                },
        },
    RunMode: "SUPERSEDED",
}
